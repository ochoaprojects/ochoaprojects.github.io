<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Session Manager for AWS" /><meta property="og:locale" content="en" /><meta name="description" content="Session Manager is the useful AWS tool that you might not be thinking about. If you’ve ever run something like ProxMox you understand just how handy it is to be able to click “console” for any of your VMs and instantly be transported to that VM as if you were sitting directly infront of the real deal with ease. This is “almost” that, but with a little more power in my opinon." /><meta property="og:description" content="Session Manager is the useful AWS tool that you might not be thinking about. If you’ve ever run something like ProxMox you understand just how handy it is to be able to click “console” for any of your VMs and instantly be transported to that VM as if you were sitting directly infront of the real deal with ease. This is “almost” that, but with a little more power in my opinon." /><link rel="canonical" href="https://ochoaprojects.github.io/posts/SessionManagerAWS/" /><meta property="og:url" content="https://ochoaprojects.github.io/posts/SessionManagerAWS/" /><meta property="og:site_name" content="OchoaProjects" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-10-04T10:00:00-07:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Session Manager for AWS" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-10-23T00:44:51-07:00","datePublished":"2022-10-04T10:00:00-07:00","description":"Session Manager is the useful AWS tool that you might not be thinking about. If you’ve ever run something like ProxMox you understand just how handy it is to be able to click “console” for any of your VMs and instantly be transported to that VM as if you were sitting directly infront of the real deal with ease. This is “almost” that, but with a little more power in my opinon.","headline":"Session Manager for AWS","mainEntityOfPage":{"@type":"WebPage","@id":"https://ochoaprojects.github.io/posts/SessionManagerAWS/"},"url":"https://ochoaprojects.github.io/posts/SessionManagerAWS/"}</script><title>Session Manager for AWS | OchoaProjects</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="OchoaProjects"><meta name="application-name" content="OchoaProjects"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/project-assets/Brandon-Ochoa-Github.jpeg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">OchoaProjects</a></div><div class="site-subtitle font-italic">A place where I post my projects and things that I am learning or working on.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/ochoaprojects" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://www.linkedin.com/in/brandon-ochoa/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="https://www.youtube.com/@ochoaprojects9930" aria-label="youtube" target="_blank" rel="noopener"> <i class="fab fa-youtube"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['brandon','ochoaprojects.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Session Manager for AWS</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Session Manager for AWS</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1664902800" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Oct 4, 2022 </em> </span> <span> Updated <em class="" data-ts="1666511091" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Oct 23, 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/ochoaprojects">Brandon Ochoa</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2007 words"> <em>11 min</em> read</span></div></div></div><div class="post-content"><p>Session Manager is the useful AWS tool that you might not be thinking about. If you’ve ever run something like ProxMox you understand just how handy it is to be able to click “console” for any of your VMs and instantly be transported to that VM as if you were sitting directly infront of the real deal with ease. This is “almost” that, but with a little more power in my opinon.</p><h2 id="table-of-contents"><span class="mr-2">Table of Contents</span><a href="#table-of-contents" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li><a href="#create-iam-role">Create IAM Role</a><li><a href="#launch-ec2-instance">Launch EC2 Instance</a><li><a href="#configure-cloudwatch">Configure CloudWatch</a><li><a href="#install-aws-cli-and-aws-session-manager-plugin">Install AWS CLI and AWS Session Manager Plugin</a><li><a href="#create-iam-policy-and-iam-user-and-iam-group">Create IAM Policy and IAM User and IAM Group</a><ul><li><a href="#iam-policy">IAM Policy</a><li><a href="#iam-group">IAM Group</a><li><a href="#iam-user">IAM User</a></ul><li><a href="#ssh-to-ec2-instance">SSH to EC2 Instance</a><li><a href="#port-forward-from-ec2-to-localhost">Port Forward from EC2 to localhost</a><ul><li><a href="#setting-up-ec2-instance">Setting Up EC2 Instance</a><li><a href="#starting-port-forward">Starting Port Forward</a></ul></ul><blockquote class="prompt-info"><div><p>The Session Manager is part of the AWS Systems Manager and if you want to know more or read up on the offical documentation, that can be found <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/what-is-systems-manager.html">here</a>.</p></div></blockquote><h1 id="create-iam-role">Create IAM Role</h1><p>When you create an AWS account, you begin with one sign-in identity that has complete access to all AWS services and resources in the account. This identity is called the AWS account root user and is accessed by signing in with the email address and password that you used to create the account. It is strongly recommended that you do not use the root user for your everyday tasks. Safeguard your root user credentials and use them to perform the tasks that only the root user can perform.</p><p>In this procedure, you use the AWS account root user to create your first user in AWS Identity and Access Management (IAM). You add this IAM user to an Administrators group, to ensure that you have access to all services and their resources in your account. The next time that you access your AWS account, you should sign in with the credentials for this IAM user. As a best practice, create only the credentials that the user needs. For example, for a user who requires access only through the AWS Management Console, do not create access keys.</p><p>Click Create Role. <img data-src="/project-assets/SessionManagerAWS/click-create-role.png" alt="Click Create Role" data-proofer-ignore></p><p>Select AWS Service and choose EC2 at the bottom. <img data-src="/project-assets/SessionManagerAWS/select-trusted-entity.png" alt="Select Trusted Entity" data-proofer-ignore></p><p>Search for “AmazonSSMFullAccess”, tick the box, click next. <img data-src="/project-assets/SessionManagerAWS/add-permissions.png" alt="Add Permissions" data-proofer-ignore></p><p>Give your role a name, review, and create it. <img data-src="/project-assets/SessionManagerAWS/review-and-create.png" alt="Review and Create" data-proofer-ignore></p><h1 id="launch-ec2-instance">Launch EC2 Instance</h1><p>AWS Systems Manager Agent (SSM Agent) is Amazon software that can be installed and configured on an EC2 instance, an on-premises server, or a virtual machine (VM). SSM Agent makes it possible for Systems Manager to update, manage, and configure these resources.</p><p>If the Amazon Machine Image (AMI) type you choose in the first procedure doesn’t come with SSM Agent preinstalled, manually install the agent on the new instance before it can be used with Systems Manager. If SSM Agent isn’t installed on the existing EC2 instance you choose in the second procedure, manually install the agent on the instance before it can be used with Systems Manager.</p><p>In most cases, SSM Agent is preinstalled on AMIs provided by AWS for the following operating systems (OSs):</p><ul><li>Amazon Linux Base AMIs dated 2017.09 and later<li>Amazon Linux 2<li>Amazon Linux 2 ECS-Optimized Base AMIs<li>Amazon EKS-Optimized Amazon Linux AMIs<li>macOS 10.14.x (Mojave), 10.15.x (Catalina), and 11.x (Big Sur)<li>SUSE Linux Enterprise Server (SLES) 12 and 15<li>Ubuntu Server 16.04, 18.04, and 20.04<li>Windows Server 2008-2012 R2 AMIs published in November 2016 or later<li>Windows Server 2016, 2019, and 2022</ul><p>Navigate to <code class="language-plaintext highlighter-rouge">EC2 &gt; Instances</code> and click “Launch Instances” in the top right hand corner and name your EC2 whatever you want. <img data-src="/project-assets/SessionManagerAWS/create-ec2.png" alt="Create EC2" data-proofer-ignore></p><p>The defaults here should be good and keep you in a “Free Tier” for learning purposes. However, the <code class="language-plaintext highlighter-rouge">most important</code> part here is the <code class="language-plaintext highlighter-rouge">Advanced details</code> at the bottom of this page. Expanding this will reveal the <code class="language-plaintext highlighter-rouge">IAM instance profile</code> option. Click the drop down and choose the IAM Role we made earlier.</p><p><img data-src="/project-assets/SessionManagerAWS/iam-instance-profile.png" alt="IAM Instance Profile" data-proofer-ignore></p><p>Now we simply launch our instance. <img data-src="/project-assets/SessionManagerAWS/launch-instance.png" alt="Launch Instance" data-proofer-ignore></p><p>Since we are using the SessionManager to connect to this EC2 instance for this exmaple we are able to complete to proceed without using a key pair. <img data-src="/project-assets/SessionManagerAWS/no-key-pair.png" alt="No Key Pair" data-proofer-ignore></p><p>With what we have so far, it should be possible for us to head over to <code class="language-plaintext highlighter-rouge">AWS Systems Manager &gt; Session Manager</code> within AWS console and click <code class="language-plaintext highlighter-rouge">Start Session</code> with the EC2 instance we just made. <img data-src="/project-assets/SessionManagerAWS/start-session.png" alt="Start Session" data-proofer-ignore> <img data-src="/project-assets/SessionManagerAWS/target-instances.png" alt="Target Instances" data-proofer-ignore> <img data-src="/project-assets/SessionManagerAWS/connected-via-ssm.png" alt="Connected Via SSM" data-proofer-ignore></p><h1 id="configure-cloudwatch">Configure CloudWatch</h1><blockquote class="prompt-info"><div><p><strong><em>What is CloudWatch?–</em></strong> Amazon CloudWatch is a monitoring and observability service built for DevOps engineers, developers, site reliability engineers (SREs), IT managers, and product owners. CloudWatch provides you with data and actionable insights to monitor your applications, respond to system-wide performance changes, and optimize resource utilization. CloudWatch collects monitoring and operational data in the form of logs, metrics, and events. You get a unified view of operational health and gain complete visibility of your AWS resources, applications, and services running on AWS and on-premises. You can use CloudWatch to detect anomalous behavior in your environments, set alarms, visualize logs and metrics side by side, take automated actions, troubleshoot issues, and discover insights to keep your applications running smoothly.</p></div></blockquote><p>This is an <code class="language-plaintext highlighter-rouge">optional step</code> but it is also very powerful. This will allow you to output your sessions as logs into CloudWatch so that you can review them later.</p><p>Start by going to <code class="language-plaintext highlighter-rouge">Cloud Watch &gt; Log Groups</code> in the console and <code class="language-plaintext highlighter-rouge">Create log group</code>. <img data-src="/project-assets/SessionManagerAWS/create-log-group.png" alt="Create Log Group" data-proofer-ignore></p><p>Give it whatever name you prefer, in this example I am going with “ssm-session”. Click “Create” <img data-src="/project-assets/SessionManagerAWS/log-group-name.png" alt="Log Group Name" data-proofer-ignore></p><p>Now we need session manager to use the log we just created. Navigate to <code class="language-plaintext highlighter-rouge">AWS Systems Manager &gt; Session Manager</code> and click on <code class="language-plaintext highlighter-rouge">Preferences</code> then <code class="language-plaintext highlighter-rouge">Edit</code>. <img data-src="/project-assets/SessionManagerAWS/session-manager-edit-preferences.png" alt="Session Manager Edit Preferences" data-proofer-ignore></p><blockquote class="prompt-info"><div><p>I disable “Enforce Encryption” for the sake of simplicity in this example.</p></div></blockquote><p>First we are going to <code class="language-plaintext highlighter-rouge">Enable</code> CloudWatch Logging. Next we are going to keep the <strong>Recommended</strong> default of <code class="language-plaintext highlighter-rouge">Stream Session Logs</code>. Then we are going to <em>uncheck</em> the <code class="language-plaintext highlighter-rouge">Enforce Encryption</code> for this log group. Lastly we are going to choose the log group we just made in our CloudWatch in the last step. <img data-src="/project-assets/SessionManagerAWS/cloudwatch-logging-settings.png" alt="CloudWatch Logging Settings" data-proofer-ignore></p><h1 id="install-aws-cli-and-aws-session-manager-plugin">Install AWS CLI and AWS Session Manager Plugin</h1><p>For this example I am on Mac. However, this can be achieved with both Windows and Linux. My recommendation for windows is to use <a href="https://chocolatey.org/install">Chocolately</a>. When using Linux you can of course use your native package manager such as RPM or APT.</p><p>While using Mac I try to leverage <a href="https://brew.sh/">Homebrew</a> when I can.</p><p>Here are the two commands that will get AWS CLI and AWS Session Manager Plugin installed on your machine for Mac.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>brew <span class="nb">install </span>awscli
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>brew <span class="nb">install</span> <span class="nt">--cask</span> session-manager-plugin
</pre></table></code></div></div><h1 id="create-iam-policy-and-iam-user-and-iam-group">Create IAM Policy and IAM User and IAM Group</h1><h2 id="iam-policy"><span class="mr-2">IAM Policy</span><a href="#iam-policy" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>To create an IAM Policy we navigate to <code class="language-plaintext highlighter-rouge">IAM Policies</code> and click “Create Policy”.</p><p><img data-src="/project-assets/SessionManagerAWS/create-iam-policy.png" alt="Create IAM Policy" data-proofer-ignore></p><p>Choose the <code class="language-plaintext highlighter-rouge">JSON</code> tab and paste in the code below. <img data-src="/project-assets/SessionManagerAWS/create-iam-policy-with-json.png" alt="Create IAM Policy With JSON" data-proofer-ignore></p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
    </span><span class="nl">"Version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2012-10-17"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Statement"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                </span><span class="s2">"ssm:StartSession"</span><span class="w">
            </span><span class="p">],</span><span class="w">
            </span><span class="nl">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                </span><span class="s2">"arn:aws:ec2:&lt;region&gt;:&lt;account-id&gt;:instance/*"</span><span class="w">
            </span><span class="p">],</span><span class="w">
            </span><span class="nl">"Condition"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"StringLike"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="nl">"ssm:resourceTag/service"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                        </span><span class="s2">"proxy"</span><span class="w">
                    </span><span class="p">]</span><span class="w">
                </span><span class="p">}</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                </span><span class="s2">"ssm:StartSession"</span><span class="w">
            </span><span class="p">],</span><span class="w">
            </span><span class="nl">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                </span><span class="s2">"arn:aws:ssm:&lt;region&gt;::document/AWS-StartPortForwardingSession"</span><span class="w">
            </span><span class="p">]</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                </span><span class="s2">"ssm:TerminateSession"</span><span class="w">
            </span><span class="p">],</span><span class="w">
            </span><span class="nl">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                </span><span class="s2">"arn:aws:ssm:*:*:session/${aws:username}-*"</span><span class="w">
            </span><span class="p">]</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><blockquote class="prompt-info"><div><p>Note the “AWS-StartPortForwardingSession” part in the above JSON. Session Manager allows for SSH tunneling and it is enabled here. This feature can be very useful as demontrated in this picture. <img data-src="/project-assets/SessionManagerAWS/session-manager-ssh-tunnel.png" alt="Session Manager SSH Tunnel" data-proofer-ignore> This command tells SSH to connect to <code class="language-plaintext highlighter-rouge">instance</code> as user <code class="language-plaintext highlighter-rouge">ec2-user</code>, open port 9999 on my local laptop, and forward everything from there to <code class="language-plaintext highlighter-rouge">localhost:80</code> on the instance. When the tunnel is established, I can point my browser at <code class="language-plaintext highlighter-rouge">http://localhost:9999</code> to connect to my private web server on port 80.</p></div></blockquote><p>Be sure to update <code class="language-plaintext highlighter-rouge">&lt;region&gt;</code> and <code class="language-plaintext highlighter-rouge">&lt;account-id&gt;</code> to the values required for your environment.</p><p>Review and name your IAM Policy and click “Create Policy”. For this example I am giving the name “DemoSessionPolicy”. <img data-src="/project-assets/SessionManagerAWS/review-and-name-iam-policy.png" alt="Review and Name IAM Policy" data-proofer-ignore></p><h2 id="iam-group"><span class="mr-2">IAM Group</span><a href="#iam-group" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Next head over to <code class="language-plaintext highlighter-rouge">IAM &gt; User groups</code> and click “Create Group”. <img data-src="/project-assets/SessionManagerAWS/create-user-group.png" alt="Create User Group" data-proofer-ignore></p><p>Name your IAM Group. In this example I am naming it “SSMUsers” because whatever user I add to this group will have access to the Session Manager and be able to use the features we add earlier such as SSH tunneling. <img data-src="/project-assets/SessionManagerAWS/name-iam-group.png" alt="Name IAM Group" data-proofer-ignore></p><p>Attach the IAM Policy that we made earlier to the IAM Group. Customer managed polcies, such as the one we made, will be listed at the top of the list for convenience. Click “Create Group” at the bottom when complete. <img data-src="/project-assets/SessionManagerAWS/attach-iam-policy.png" alt="Attach IAM Policy" data-proofer-ignore></p><h2 id="iam-user"><span class="mr-2">IAM User</span><a href="#iam-user" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Next head over to <code class="language-plaintext highlighter-rouge">IAM &gt; Users</code> and click “Add User”. <img data-src="/project-assets/SessionManagerAWS/iam-users-add-user.png" alt="IAM Users Add User" data-proofer-ignore></p><p>Name your user and choose <code class="language-plaintext highlighter-rouge">Access Key - Programmatic access</code> for AWS credential type. We choose this because this user does not need to access the console and only want to be access the AWS resources using SSM through things such as the AWS CLI. Click “Next: Permissions” at the bottom when complete. <img data-src="/project-assets/SessionManagerAWS/configure-iam-user.png" alt="Configure IAM User" data-proofer-ignore></p><p>Since we already have a group set up from the previous step, we can simply add our new user to the group we just created in this step by ensuring <code class="language-plaintext highlighter-rouge">Add user to group</code> is selected, checking the box next to the group we want to be added to, and then clicking “Next: Tags” at the bottom. <img data-src="/project-assets/SessionManagerAWS/add-iam-user-to-group.png" alt="Add IAM User to Group" data-proofer-ignore></p><p>I don’t add any tags for this exmaple. Simply click “Next: Review”.</p><p>Click “Create User”. <img data-src="/project-assets/SessionManagerAWS/click-create-user.png" alt="Click Create User" data-proofer-ignore></p><blockquote class="prompt-danger"><div><p>IMPORTANT! AWS Console will immediately provide us the <code class="language-plaintext highlighter-rouge">Access key ID</code> and <code class="language-plaintext highlighter-rouge">Secret access key</code> on the next screen because we chose the “Programmatic” access for this user. It is very important that you document this information somewhere safe that you know you will be able to access and find again. There is a <code class="language-plaintext highlighter-rouge">Download .csv</code> option here which is a useful quick and easy step. However, I recommend using something like the <code class="language-plaintext highlighter-rouge">AWS Secrets Manager</code> for storing information such as this (This feature is not free and will cost a small fee). <code class="language-plaintext highlighter-rouge">If you close this screen without saving the information, you will *NOT* be able to retrieve this information again and you *WILL* need to recreate a new user to recreate the information.</code></p></div></blockquote><p>Document your <code class="language-plaintext highlighter-rouge">Access key ID</code> and <code class="language-plaintext highlighter-rouge">Secret access key</code> someplace safe and where you can find it again. <img data-src="/project-assets/SessionManagerAWS/save-access-and-secret-key-ids.png" alt="Save Access and Secret Key IDs" data-proofer-ignore></p><h1 id="ssh-to-ec2-instance">SSH to EC2 Instance</h1><p>Now that we have an IAM User, Role, Group, Policy set up and AWS CLI plus Session Manager Plugin installed we can ssh into our EC2 resource with the AWS CLI.</p><p>First we need to configure our AWS CLI witht the following command.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>aws configure
</pre></table></code></div></div><p>Next we will provide that <code class="language-plaintext highlighter-rouge">AWS Access Key ID</code> and <code class="language-plaintext highlighter-rouge">AWS Secret Access Key</code> that we definitely documented earlier.</p><p>Afterwards it will ask for the following- <code class="language-plaintext highlighter-rouge">Default region name</code>: us-east-2 (This is my setting) <code class="language-plaintext highlighter-rouge">Default output format</code>: json (This is default and what I used)</p><p>To start a session run the following command. Replace <code class="language-plaintext highlighter-rouge">&lt;instance-id&gt;</code> with your own instance-id.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>aws ssm start-session <span class="nt">--target</span> &lt;instance-id&gt;
</pre></table></code></div></div><p><img data-src="/project-assets/SessionManagerAWS/successful-ssh-connection.png" alt="Successful SSH Connection" data-proofer-ignore></p><h1 id="port-forward-from-ec2-to-localhost">Port Forward from EC2 to localhost</h1><h2 id="setting-up-ec2-instance"><span class="mr-2">Setting Up EC2 Instance</span><a href="#setting-up-ec2-instance" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>To demonstrate the port forwarding feature we will use a simple NGINX server on our demo ec2 instance.</p><p>Let’s start by installing NGINX with the linux package manager by using the following command.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>amazon-linux-extras <span class="nb">install </span>nginx1 <span class="nt">-y</span>
</pre></table></code></div></div><p>I chose the Linux AMI provided by Amazon and therefore I am not using something such as yum or apt. Instead it uses “amazon-linux-extras”.</p><p>After NGINX is installed, let’s us systemd to start and check our server’s status.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>systemctl start nginx
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>systemctl status nginx
</pre></table></code></div></div><p>Now we will see that our NGINX server is active and running.</p><h2 id="starting-port-forward"><span class="mr-2">Starting Port Forward</span><a href="#starting-port-forward" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Let’s start a port forward session with the following command. Be sure to enter the correct <code class="language-plaintext highlighter-rouge">ec2-instance-id</code> for your command.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>aws ssm start-session <span class="se">\</span>
    <span class="nt">--target</span> &lt;ec2-instace-id&gt; <span class="se">\</span>
    <span class="nt">--document-name</span> AWS-StartPortForwardingSession <span class="se">\</span>
    <span class="nt">--parameters</span> <span class="s1">'{"portNumber":["80"], "localPortNumber":["8080"]}'</span>
</pre></table></code></div></div><p>Your terminal will display that it is <code class="language-plaintext highlighter-rouge">Waiting for connections...</code></p><p>Let’s make that connection! Simply open your browser from your local machine that you are running the AWS SSM command from and navigate to <code class="language-plaintext highlighter-rouge">http://localhost:8080</code> and you will be greeted with “Welcome to NGINX on Amazon Linux!”</p><p>We have successfully created and used our SSH Tunnel with the SSM!</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/cloud-providers/'>Cloud Providers</a>, <a href='/categories/amazon-web-services-aws/'>Amazon Web Services (AWS)</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/aws/" class="post-tag no-text-decoration" >aws</a> <a href="/tags/amazon/" class="post-tag no-text-decoration" >amazon</a> <a href="/tags/session-manager/" class="post-tag no-text-decoration" >session manager</a> <a href="/tags/ssh-tunnel/" class="post-tag no-text-decoration" >ssh tunnel</a> <a href="/tags/iam/" class="post-tag no-text-decoration" >iam</a> <a href="/tags/ec2/" class="post-tag no-text-decoration" >ec2</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Session+Manager+for+AWS+-+OchoaProjects&url=https%3A%2F%2Fochoaprojects.github.io%2Fposts%2FSessionManagerAWS%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Session+Manager+for+AWS+-+OchoaProjects&u=https%3A%2F%2Fochoaprojects.github.io%2Fposts%2FSessionManagerAWS%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fochoaprojects.github.io%2Fposts%2FSessionManagerAWS%2F&text=Session+Manager+for+AWS+-+OchoaProjects" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/ProxMoxSetupInstall/">ProxMox Setup and Installation</a><li><a href="/posts/AboutMeAndTopology/">About Me and Homelab Topology</a><li><a href="/posts/PlexAutomation/">Plex Automation</a><li><a href="/posts/ProxMoxCloudInitImage/">Create a Debian Cloud-Init Template on Proxmox</a><li><a href="/posts/ProvisionDockerWithAnsible/">Provision a Linux Server With Docker Using Ansible</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/automation/">automation</a> <a class="post-tag" href="/tags/aws/">aws</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/proxmox/">proxmox</a> <a class="post-tag" href="/tags/terraform/">terraform</a> <a class="post-tag" href="/tags/cloudinit/">cloudinit</a> <a class="post-tag" href="/tags/containers/">containers</a> <a class="post-tag" href="/tags/ec2/">ec2</a> <a class="post-tag" href="/tags/kubernetes/">kubernetes</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/TerraformWithAWS/"><div class="card-body"> <em class="small" data-ts="1656435600" data-df="ll" > Jun 28, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Automating AWS VPC and EC2 Instances using Terraform</h3><div class="text-muted small"><p> Terraform is a powerful tool that allows us to automate infrastructure in our cloud providers and much more. Using terraform to automate the building and configuration of our AWS enviornment to be ...</p></div></div></a></div><div class="card"> <a href="/posts/CheckS3BucketsWithLambdaFunction/"><div class="card-body"> <em class="small" data-ts="1656349200" data-df="ll" > Jun 27, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Checking AWS S3 Buckets With Python Lambda Function</h3><div class="text-muted small"><p> This will be a basic example on using a python Lambda function to check S3 Buckets. Table of Contents Create a Lambda Function in AWS Python Code Source for Function Explaining the...</p></div></div></a></div><div class="card"> <a href="/posts/UsingAWSLambdaWithAPIGateway/"><div class="card-body"> <em class="small" data-ts="1658768400" data-df="ll" > Jul 25, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Using AWS Lambda and API Gateway to Check URLs</h3><div class="text-muted small"><p> Using AWS Lambda Python functions and an API Gateway to deploy a URL Checker that looks for known malicious websites all while being serveless through Amazon Web Services. Table of Contents Ov...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/UsingAWSLambdaWithAPIGateway/" class="btn btn-outline-primary" prompt="Older"><p>Using AWS Lambda and API Gateway to Check URLs</p></a> <a href="/posts/2022-DevOpsTheGitLabWay/" class="btn btn-outline-primary" prompt="Newer"><p>DevOps the GitLab Way</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://github.com/ochoaprojects">Brandon Ochoa</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> hosted on Github</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/automation/">automation</a> <a class="post-tag" href="/tags/aws/">aws</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/proxmox/">proxmox</a> <a class="post-tag" href="/tags/terraform/">terraform</a> <a class="post-tag" href="/tags/cloudinit/">cloudinit</a> <a class="post-tag" href="/tags/containers/">containers</a> <a class="post-tag" href="/tags/ec2/">ec2</a> <a class="post-tag" href="/tags/kubernetes/">kubernetes</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
