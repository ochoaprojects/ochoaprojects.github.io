<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Using AWS Lambda and API Gateway to Check URLs" /><meta property="og:locale" content="en" /><meta name="description" content="Using AWS Lambda Python functions and an API Gateway to deploy a URL Checker that looks for known malicious websites all while being serveless through Amazon Web Services." /><meta property="og:description" content="Using AWS Lambda Python functions and an API Gateway to deploy a URL Checker that looks for known malicious websites all while being serveless through Amazon Web Services." /><link rel="canonical" href="https://ochoaprojects.github.io/posts/UsingAWSLambdaWithAPIGateway/" /><meta property="og:url" content="https://ochoaprojects.github.io/posts/UsingAWSLambdaWithAPIGateway/" /><meta property="og:site_name" content="OchoaProjects" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-07-25T10:00:00-07:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Using AWS Lambda and API Gateway to Check URLs" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-07-25T10:00:00-07:00","datePublished":"2022-07-25T10:00:00-07:00","description":"Using AWS Lambda Python functions and an API Gateway to deploy a URL Checker that looks for known malicious websites all while being serveless through Amazon Web Services.","headline":"Using AWS Lambda and API Gateway to Check URLs","mainEntityOfPage":{"@type":"WebPage","@id":"https://ochoaprojects.github.io/posts/UsingAWSLambdaWithAPIGateway/"},"url":"https://ochoaprojects.github.io/posts/UsingAWSLambdaWithAPIGateway/"}</script><title>Using AWS Lambda and API Gateway to Check URLs | OchoaProjects</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="OchoaProjects"><meta name="application-name" content="OchoaProjects"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/project-assets/Brandon-Ochoa-Github.jpeg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">OchoaProjects</a></div><div class="site-subtitle font-italic">A place where I post my projects and things that I am learning or working on.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/ochoaprojects" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://www.linkedin.com/in/brandon-ochoa/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="https://www.youtube.com/@ochoaprojects9930" aria-label="youtube" target="_blank" rel="noopener"> <i class="fab fa-youtube"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['brandon','ochoaprojects.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Using AWS Lambda and API Gateway to Check URLs</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Using AWS Lambda and API Gateway to Check URLs</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1658768400" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Jul 25, 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/ochoaprojects">Brandon Ochoa</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2326 words"> <em>12 min</em> read</span></div></div></div><div class="post-content"><p>Using AWS Lambda Python functions and an API Gateway to deploy a URL Checker that looks for known malicious websites all while being serveless through Amazon Web Services.</p><h2 id="table-of-contents"><span class="mr-2">Table of Contents</span><a href="#table-of-contents" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li><a href="#overview">Overview</a><li><a href="#dynamodb">DynamoDB</a><ul><li><a href="#dynamodbtf">dynamodb.tf</a></ul><li><a href="#aws-lambda-functions">AWS Lambda Functions</a><ul><li><a href="#getmalwarecheckpy">getMalwareCheck.py</a><li><a href="#postmalwarecheckpy">postMalwareCheck.py</a><li><a href="#lambdatf">lambda.tf</a><li><a href="#dynamodbpolicyjson">dynamodbpolicy.json</a></ul><li><a href="#lambda-layer">Lambda Layer</a><ul><li><a href="#to-create-a-lambda-layer">To Create a Lambda Layer</a></ul><li><a href="#api-gateway">API Gateway</a><ul><li><a href="#apigatewaytf">apigateway.tf</a></ul><li><a href="#cloudwatch">CloudWatch</a><li><a href="#test">Test</a></ul><h1 id="overview">Overview</h1><p>The goal here is to setup some AWS infrastructure so that we can send GET requests to an API and have it trigger our AWS Lambda function written in python to check against a database of URLs that give us response one whether or not the URL we provided is in fact a known malicious site. Additionally there will be a functionality to use the same API Gateway to POST new URLs to the database through a seperate Lambda function by using a seperate route. In the end we want to deploy this all automatically through just Terraform.</p><p>The flow will look like this: <img data-src="/project-assets/UsingAWSLambdaWithAPIGateway/datapath.png" alt="Data Path" data-proofer-ignore></p><h1 id="dynamodb">DynamoDB</h1><p>I went with DynamoDB as it is a fully managed, serverless, NoSQL database. DynamoDB offers built-in security, continuous backups, automated multi-Region replication, in-memory caching, and data export tools. Because the database backend wasn’t very complex and didn’t require multiple tables, but could grow to thousands of URLs, I wanted a non-relational database.</p><p>I started by building the DynamoDB using Terraform. I did this manually using the aws_dynamodb_table resource, but ran into a few issues. Eventually I switched to using the dynamodb-table AWS module from Anton Babenko for speed’s sake and a clean deploy.</p><p>I went with a Provisioned billing mode over On-Demand, as it was easy to limit the read/write capacity for this proof of concept, but it could easily be increased.</p><p>The database had a very simple attribute setup:</p><div class="language-terraform highlighter-rouge"><div class="code-header"> <span data-label-text="Terraform"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="nx">attributes</span> <span class="err">=</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nx">name</span> <span class="p">=</span> <span class="s2">"BlacklistURL"</span>
      <span class="nx">type</span> <span class="p">=</span> <span class="s2">"S"</span>
    <span class="p">}</span>
</pre></table></code></div></div><p>This sets up a way to store URLs as strings in “BlacklistURL”. Once I had the database built, I tested it by going to the AWS Console DynamoDB section, and manually adding a few items:</p><p><img data-src="/project-assets/UsingAWSLambdaWithAPIGateway/DynamoDBCreateItem.png" alt="DynamoDB Create Item" data-proofer-ignore></p><p>From the DynamoDB menus under Tables &gt; Explore Items, I can see the items being successfully added:</p><p><img data-src="/project-assets/UsingAWSLambdaWithAPIGateway/ExploreDynamoDBItems.png" alt="Explore DynamoDB Items" data-proofer-ignore></p><h3 id="dynamodbtf"><span class="mr-2">dynamodb.tf</span><a href="#dynamodbtf" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-terraform highlighter-rouge"><div class="code-header"> <span data-label-text="Terraform"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="c1"># --- dynamodb.tf ---</span>

<span class="k">module</span> <span class="s2">"dynamodb_table"</span> <span class="p">{</span>
  <span class="nx">source</span> <span class="p">=</span> <span class="s2">"terraform-aws-modules/dynamodb-table/aws"</span>

  <span class="nx">name</span>     <span class="p">=</span> <span class="s2">"MalwareBlacklist"</span>
  <span class="nx">hash_key</span> <span class="p">=</span> <span class="s2">"BlacklistURL"</span>

  <span class="nx">billing_mode</span>   <span class="p">=</span> <span class="s2">"PROVISIONED"</span>
  <span class="nx">read_capacity</span>  <span class="p">=</span> <span class="mi">10</span>
  <span class="nx">write_capacity</span> <span class="p">=</span> <span class="mi">10</span>

  <span class="nx">attributes</span> <span class="p">=</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nx">name</span> <span class="p">=</span> <span class="s2">"BlacklistURL"</span>
      <span class="nx">type</span> <span class="p">=</span> <span class="s2">"S"</span>
    <span class="p">}</span>
  <span class="p">]</span>

  <span class="nx">tags</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">Terraform</span>   <span class="p">=</span> <span class="s2">"true"</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h1 id="aws-lambda-functions">AWS Lambda Functions</h1><p>Now that the database was set up and available in AWS, I had to start coding my Lambda functions. I decided to use Python, and I was aware of a few modules I could use to simplify my coding.</p><p>Boto3 is the AWS SDK for Python. It allows you to directly create, update, and delete AWS resources from your Python scripts. Now while I will be using Terraform for handling all of the infrastructure, this did give an easy way to interact with DynamoDB.</p><p>Although I could have used one Python script and had different behavior based on the event, I decided to have two separate Lambda functions to make the routing of the requests more logically separate. I started by building the <code class="language-plaintext highlighter-rouge">getMalwareCheck.py</code> function to read from the database and check for the URL, and then did the <code class="language-plaintext highlighter-rouge">postMalwareCheck.py</code> to add new values to the database.</p><p>I set up the client connection to the database, specified the table, and then set up a variable for the input to the function. I used the validators Python library to do a quick check on the input to make sure it was a proper URL.</p><p>Once the Python was ready, I was able to run it locally, providing hardcoded inputs, and verify if I was able to get results from the table properly, or add to the table; checking in the AWS Console.</p><p>Once everything checked out, I tested running the Lambda functions locally using the <a href="https://pypi.org/project/python-lambda-local/">python-lambda-local</a> project. I wrote some JSON files with the inputs that the functions would expect to get to test with as input.</p><p>Once that worked, I wrote the Terraform to build the Lambda functions. A very cool method I found is that you can specify a data object, that would auto-build the Python code as a zip file:</p><div class="language-terraform highlighter-rouge"><div class="code-header"> <span data-label-text="Terraform"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">data</span> <span class="s2">"archive_file"</span> <span class="s2">"malware_post_zip"</span> <span class="p">{</span>
  <span class="nx">type</span>        <span class="p">=</span> <span class="s2">"zip"</span>
  <span class="nx">source_file</span> <span class="p">=</span> <span class="s2">"../python/postMalwareCheck.py"</span>
  <span class="nx">output_path</span> <span class="p">=</span> <span class="s2">"../python/postmalwarecheck.zip"</span>
</pre></table></code></div></div><blockquote class="prompt-tip"><div><p>Note: that this only works in simple cases. If the <a href="https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-limits.html">deployment package</a> is larger than 50MB, direct upload isn’t possible. Typically you would need to upload the zip file to an S3 bucket then call it to the Lambda function from there. <img data-src="/project-assets/UsingAWSLambdaWithAPIGateway/DirectUploadLimit.png" alt="Direct Upload Limit" data-proofer-ignore></p></div></blockquote><h3 id="getmalwarecheckpy"><span class="mr-2">getMalwareCheck.py</span><a href="#getmalwarecheckpy" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
</pre><td class="rouge-code"><pre><span class="c1">#!/usr/bin/python3
</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">validators</span>
<span class="kn">from</span> <span class="nn">boto3.dynamodb.conditions</span> <span class="kn">import</span> <span class="n">Key</span>

<span class="c1"># Lambda Handler - cannot modify this method
</span><span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>  

  <span class="c1"># Logging for CloudWatch
</span>  <span class="k">print</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

  <span class="n">dynamodb_client</span> <span class="o">=</span> <span class="n">boto3</span><span class="p">.</span><span class="n">client</span><span class="p">(</span><span class="s">'dynamodb'</span><span class="p">)</span>
  <span class="n">dynamodb</span> <span class="o">=</span> <span class="n">boto3</span><span class="p">.</span><span class="n">resource</span><span class="p">(</span><span class="s">'dynamodb'</span><span class="p">)</span>
  <span class="n">table</span> <span class="o">=</span> <span class="n">dynamodb</span><span class="p">.</span><span class="n">Table</span><span class="p">(</span><span class="s">'MalwareBlacklist'</span><span class="p">)</span>
  <span class="n">MalwareURL</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s">'queryStringParameters'</span><span class="p">][</span><span class="s">'MalwareURL'</span><span class="p">]</span>

  <span class="k">try</span><span class="p">:</span>
    <span class="c1"># Validate that the input is a proper URL.  Raise exception if it is not.
</span>    <span class="n">validurl</span><span class="o">=</span><span class="n">validators</span><span class="p">.</span><span class="n">url</span><span class="p">(</span><span class="n">MalwareURL</span><span class="p">)</span>        

    <span class="k">if</span> <span class="n">validurl</span><span class="o">==</span><span class="bp">True</span><span class="p">:</span>
      <span class="c1"># Query DynamoDB for the MalwareURL:             
</span>      <span class="n">response</span> <span class="o">=</span> <span class="n">table</span><span class="p">.</span><span class="n">query</span><span class="p">(</span><span class="n">KeyConditionExpression</span><span class="o">=</span><span class="n">Key</span><span class="p">(</span><span class="s">'BlacklistURL'</span><span class="p">).</span><span class="n">eq</span><span class="p">(</span><span class="n">MalwareURL</span><span class="p">))</span>      
      <span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>      

      <span class="c1"># If the URL exists in the table, the ScannedCount will be &gt; 0      
</span>      <span class="k">if</span> <span class="n">response</span><span class="p">[</span><span class="s">'Count'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
          <span class="s">'statusCode'</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
          <span class="s">'body'</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="s">'URL is present in blacklist!'</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="k">elif</span> <span class="n">response</span><span class="p">[</span><span class="s">'Count'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
          <span class="s">'statusCode'</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
          <span class="s">'body'</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="s">'URL is not found in blacklist.  Proceed.'</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="k">else</span><span class="p">:</span>                 
        <span class="k">return</span> <span class="p">{</span>
          <span class="s">'statusCode'</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span>
          <span class="s">'body'</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="s">'We have  problem with the count check'</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">raise</span> <span class="nb">Exception</span><span class="p">(</span><span class="s">'We have a problem with the count check.'</span><span class="p">)</span>    
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="p">{</span>
          <span class="s">'statusCode'</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span>
          <span class="s">'body'</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="s">'The URL is not valid.'</span><span class="p">)</span>
        <span class="p">}</span>       
      <span class="k">raise</span> <span class="nb">Exception</span><span class="p">(</span><span class="s">'URL is not valid.'</span><span class="p">)</span>
  
  <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">{</span>
          <span class="s">'statusCode'</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span>
          <span class="s">'body'</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="s">'There was a problem querying the blacklist.'</span><span class="p">)</span>
        <span class="p">}</span>
</pre></table></code></div></div><h3 id="postmalwarecheckpy"><span class="mr-2">postMalwareCheck.py</span><a href="#postmalwarecheckpy" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre><td class="rouge-code"><pre><span class="n">postMalwareCheck</span><span class="p">.</span><span class="n">py</span>
<span class="c1">#!/usr/bin/python3
</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">validators</span>
<span class="kn">from</span> <span class="nn">boto3.dynamodb.conditions</span> <span class="kn">import</span> <span class="n">Key</span>

<span class="c1"># Lambda Handler - cannot modify this method
</span><span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>

  <span class="c1"># Logging for CloudWatch
</span>  <span class="k">print</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
  
  <span class="n">dynamodb</span> <span class="o">=</span> <span class="n">boto3</span><span class="p">.</span><span class="n">resource</span><span class="p">(</span><span class="s">'dynamodb'</span><span class="p">)</span>
  <span class="n">client</span> <span class="o">=</span> <span class="n">boto3</span><span class="p">.</span><span class="n">client</span><span class="p">(</span><span class="s">'dynamodb'</span><span class="p">)</span>
  <span class="n">table</span> <span class="o">=</span> <span class="n">dynamodb</span><span class="p">.</span><span class="n">Table</span><span class="p">(</span><span class="s">'MalwareBlacklist'</span><span class="p">)</span>
  <span class="n">MalwareURL</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s">'queryStringParameters'</span><span class="p">][</span><span class="s">'MalwareURL'</span><span class="p">]</span>

  <span class="c1"># Putting a try/catch to log to the user when an error occurs posting the URL,
</span>  <span class="k">try</span><span class="p">:</span>

    <span class="c1"># Validate if this is a valid URL.  Raise exception if it is not,
</span>    <span class="n">valid</span><span class="o">=</span><span class="n">validators</span><span class="p">.</span><span class="n">url</span><span class="p">(</span><span class="n">MalwareURL</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">valid</span><span class="o">==</span><span class="bp">True</span><span class="p">:</span>
      <span class="n">table</span><span class="p">.</span><span class="n">put_item</span><span class="p">(</span>
        <span class="n">Item</span><span class="o">=</span><span class="p">{</span>
          <span class="s">'BlacklistURL'</span><span class="p">:</span> <span class="n">MalwareURL</span>
          <span class="p">}</span>
        <span class="p">)</span>
      <span class="k">return</span> <span class="p">{</span>
        <span class="s">'statusCode'</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
        <span class="s">'body'</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="s">'New Malware URL Added to Blacklist Successfully!'</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">raise</span>
  
  <span class="k">except</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="s">'statusCode'</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span>
      <span class="s">'body'</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="s">'Error adding new Malware URL to Blacklist.'</span><span class="p">)</span>
    <span class="p">}</span>
</pre></table></code></div></div><h3 id="lambdatf"><span class="mr-2">lambda.tf</span><a href="#lambdatf" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-terraform highlighter-rouge"><div class="code-header"> <span data-label-text="Terraform"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
</pre><td class="rouge-code"><pre><span class="c1"># --- lambda.tf ---</span>

<span class="k">data</span> <span class="s2">"aws_iam_policy_document"</span> <span class="s2">"lambda_assume_role_policy"</span> <span class="p">{</span>
  <span class="nx">statement</span> <span class="p">{</span>
    <span class="nx">effect</span>  <span class="p">=</span> <span class="s2">"Allow"</span>
    <span class="nx">actions</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"sts:AssumeRole"</span><span class="p">]</span>
    <span class="nx">principals</span> <span class="p">{</span>
      <span class="nx">type</span>        <span class="p">=</span> <span class="s2">"Service"</span>
      <span class="nx">identifiers</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"lambda.amazonaws.com"</span><span class="p">]</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">resource</span> <span class="s2">"aws_iam_role"</span> <span class="s2">"lambda_role"</span> <span class="p">{</span>
  <span class="nx">name</span>               <span class="p">=</span> <span class="s2">"lambda-lambdarole"</span>
  <span class="nx">assume_role_policy</span> <span class="p">=</span> <span class="k">data</span><span class="p">.</span><span class="nx">aws_iam_policy_document</span><span class="p">.</span><span class="nx">lambda_assume_role_policy</span><span class="p">.</span><span class="nx">json</span>

  <span class="nx">inline_policy</span> <span class="p">{</span>
    <span class="nx">name</span>   <span class="p">=</span> <span class="s2">"allow_dynamodb"</span>
    <span class="nx">policy</span> <span class="p">=</span> <span class="nx">file</span><span class="p">(</span><span class="s2">"dynamodbpolicy.json"</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>


<span class="k">resource</span> <span class="s2">"aws_lambda_layer_version"</span> <span class="s2">"lambda_layer"</span> <span class="p">{</span>
  <span class="nx">filename</span>            <span class="p">=</span> <span class="s2">"../lambdalayer/lambdalayer.zip"</span>
  <span class="nx">layer_name</span>          <span class="p">=</span> <span class="s2">"lambdalayer"</span>
  <span class="nx">compatible_runtimes</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"python3.9"</span><span class="p">]</span>
<span class="p">}</span>


<span class="k">data</span> <span class="s2">"archive_file"</span> <span class="s2">"malware_post_zip"</span> <span class="p">{</span>
  <span class="nx">type</span>        <span class="p">=</span> <span class="s2">"zip"</span>
  <span class="nx">source_file</span> <span class="p">=</span> <span class="s2">"../python/postMalwareCheck.py"</span>
  <span class="nx">output_path</span> <span class="p">=</span> <span class="s2">"../python/postmalwarecheck.zip"</span>
<span class="p">}</span>

<span class="k">resource</span> <span class="s2">"aws_lambda_function"</span> <span class="s2">"malware_post_function"</span> <span class="p">{</span>
  <span class="nx">function_name</span>    <span class="p">=</span> <span class="s2">"MalwarePostFunction"</span>
  <span class="nx">filename</span>         <span class="p">=</span> <span class="s2">"../python/postmalwarecheck.zip"</span>
  <span class="nx">source_code_hash</span> <span class="p">=</span> <span class="k">data</span><span class="p">.</span><span class="nx">archive_file</span><span class="p">.</span><span class="nx">malware_post_zip</span><span class="p">.</span><span class="nx">output_base64sha256</span>
  <span class="nx">role</span>             <span class="p">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">lambda_role</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">runtime</span>          <span class="p">=</span> <span class="s2">"python3.9"</span>
  <span class="nx">handler</span>          <span class="p">=</span> <span class="s2">"postMalwareCheck.lambda_handler"</span>
  <span class="nx">timeout</span>          <span class="p">=</span> <span class="mi">10</span>
  <span class="nx">layers</span>           <span class="p">=</span> <span class="p">[</span><span class="nx">aws_lambda_layer_version</span><span class="p">.</span><span class="nx">lambda_layer</span><span class="p">.</span><span class="nx">arn</span><span class="p">]</span>
<span class="p">}</span>

<span class="k">data</span> <span class="s2">"archive_file"</span> <span class="s2">"malware_get_zip"</span> <span class="p">{</span>
  <span class="nx">type</span>        <span class="p">=</span> <span class="s2">"zip"</span>
  <span class="nx">source_file</span> <span class="p">=</span> <span class="s2">"../python/getMalwareCheck.py"</span>
  <span class="nx">output_path</span> <span class="p">=</span> <span class="s2">"../python/getmalwarecheck.zip"</span>
<span class="p">}</span>

<span class="k">resource</span> <span class="s2">"aws_lambda_function"</span> <span class="s2">"malware_get_function"</span> <span class="p">{</span>
  <span class="nx">function_name</span>    <span class="p">=</span> <span class="s2">"MalwareGetFunction"</span>
  <span class="nx">filename</span>         <span class="p">=</span> <span class="s2">"../python/getmalwarecheck.zip"</span>
  <span class="nx">source_code_hash</span> <span class="p">=</span> <span class="k">data</span><span class="p">.</span><span class="nx">archive_file</span><span class="p">.</span><span class="nx">malware_get_zip</span><span class="p">.</span><span class="nx">output_base64sha256</span>
  <span class="nx">role</span>             <span class="p">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">lambda_role</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">runtime</span>          <span class="p">=</span> <span class="s2">"python3.9"</span>
  <span class="nx">handler</span>          <span class="p">=</span> <span class="s2">"getMalwareCheck.lambda_handler"</span>
  <span class="nx">timeout</span>          <span class="p">=</span> <span class="mi">10</span>
  <span class="nx">layers</span>           <span class="p">=</span> <span class="p">[</span><span class="nx">aws_lambda_layer_version</span><span class="p">.</span><span class="nx">lambda_layer</span><span class="p">.</span><span class="nx">arn</span><span class="p">]</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="dynamodbpolicyjson"><span class="mr-2">dynamodbpolicy.json</span><a href="#dynamodbpolicyjson" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
    </span><span class="nl">"Version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2012-10-17"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Statement"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
              </span><span class="s2">"dynamodb:BatchGetItem"</span><span class="p">,</span><span class="w">
              </span><span class="s2">"dynamodb:GetItem"</span><span class="p">,</span><span class="w">
              </span><span class="s2">"dynamodb:Scan"</span><span class="p">,</span><span class="w">
              </span><span class="s2">"dynamodb:Query"</span><span class="p">,</span><span class="w">
              </span><span class="s2">"dynamodb:BatchWriteItem"</span><span class="p">,</span><span class="w">
              </span><span class="s2">"dynamodb:PutItem"</span><span class="p">,</span><span class="w">
              </span><span class="s2">"dynamodb:UpdateItem"</span><span class="p">,</span><span class="w">
              </span><span class="s2">"dynamodb:DeleteItem"</span><span class="w">
            </span><span class="p">],</span><span class="w">
            </span><span class="nl">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="s2">"arn:aws:dynamodb:*"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><h1 id="lambda-layer">Lambda Layer</h1><p>Often times you see or hear of Python virtual environments that have all the dependencies for a particular Python program to run. In this case we are not on a local machine running our Python code, but we still need the proper environment for our dependencies to be available. We can accomplish this in AWS by using a Lambda Layer. With a Lambda Layer we are able to specify it easily in Terraform along with the Lambda functions, and could be reused for multiple functions. A Lambda layer is a .zip file archive that can contain additional code or other content. A layer can contain libraries, a custom runtime, data, or configuration files.</p><h3 id="to-create-a-lambda-layer"><span class="mr-2">To Create a Lambda Layer</span><a href="#to-create-a-lambda-layer" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ol><li>Create a directory where we want to install our requests package: <code class="language-plaintext highlighter-rouge">mkdir -p layer/python/lib/python3.9/site-packages</code><li>Run <code class="language-plaintext highlighter-rouge">pip3 install &lt;package&gt; -t layer/python/lib/python3.9/site-packages/</code><li>Access the layer folder: <code class="language-plaintext highlighter-rouge">cd layer</code><li>Zip the python folder containing all of the required files: <code class="language-plaintext highlighter-rouge">zip -r lambdalayer.zip *</code><li>Copy the zip file to a location where it can be referenced by Terraform.</ol><p>Resulting Output for this Project: <a href="/project-assets/UsingAWSLambdaWithAPIGateway/lambdalayer.zip">lambdalayer.zip</a></p><p>Once the Lambda Layer was added to the Terraform resources, I was able to test the Lambda functions successfully in the AWS console: <img data-src="/project-assets/UsingAWSLambdaWithAPIGateway/LambdaTest.png" alt="Lambda Test" data-proofer-ignore></p><h1 id="api-gateway">API Gateway</h1><p>Using an HTTP API instead of a REST API made the most sense for this project as it is more of a proof of concept and learning experience rather than a full fledged deployed piece of infrastructure. It is also simple and straight forward while being cheaper.</p><p>Here is the main receipe for the API Gateway:</p><ul><li>Create the API Gateway itself.<li>Create a Stage for deployment. In my case I used the $default stage, which was set to auto-deploy.<li>Create two Routes for the HTTP GET or POST traffic to be picked up, and send to their respective integrations.<li>Create two Integrations to pass the HTTP GET or POST traffic to be passed to the proper Lambda function.<li>Add permissions so the API Gateway has permission to invoke the Lambda function.</ul><h3 id="apigatewaytf"><span class="mr-2">apigateway.tf</span><a href="#apigatewaytf" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-terraform highlighter-rouge"><div class="code-header"> <span data-label-text="Terraform"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
</pre><td class="rouge-code"><pre><span class="c1"># --- apigateway.tf ---</span>

<span class="k">resource</span> <span class="s2">"aws_apigatewayv2_api"</span> <span class="s2">"lambdagateway"</span> <span class="p">{</span>
  <span class="nx">name</span>          <span class="p">=</span> <span class="s2">"malware_http_gateway"</span>
  <span class="nx">description</span>   <span class="p">=</span> <span class="s2">"HTTP API Malware Check Gateway"</span>
  <span class="nx">protocol_type</span> <span class="p">=</span> <span class="s2">"HTTP"</span>
<span class="p">}</span>

<span class="k">resource</span> <span class="s2">"aws_apigatewayv2_stage"</span> <span class="s2">"lambdastage"</span> <span class="p">{</span>
  <span class="nx">api_id</span>      <span class="p">=</span> <span class="nx">aws_apigatewayv2_api</span><span class="p">.</span><span class="nx">lambdagateway</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">name</span>        <span class="p">=</span> <span class="s2">"</span><span class="err">$</span><span class="s2">default"</span>
  <span class="nx">auto_deploy</span> <span class="p">=</span> <span class="kc">true</span>
  <span class="nx">access_log_settings</span> <span class="p">{</span>
    <span class="nx">destination_arn</span> <span class="p">=</span> <span class="nx">aws_cloudwatch_log_group</span><span class="p">.</span><span class="nx">api_gw</span><span class="p">.</span><span class="nx">arn</span>
    <span class="nx">format</span> <span class="p">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
      <span class="s2">"requestId"</span> <span class="err">:</span> <span class="s2">"</span><span class="err">$</span><span class="s2">context.requestId"</span><span class="p">,</span>
      <span class="s2">"extendedRequestId"</span> <span class="err">:</span> <span class="s2">"</span><span class="err">$</span><span class="s2">context.extendedRequestId"</span><span class="p">,</span>
      <span class="s2">"ip"</span> <span class="err">:</span> <span class="s2">"</span><span class="err">$</span><span class="s2">context.identity.sourceIp"</span><span class="p">,</span>
      <span class="s2">"caller"</span> <span class="err">:</span> <span class="s2">"</span><span class="err">$</span><span class="s2">context.identity.caller"</span><span class="p">,</span>
      <span class="s2">"user"</span> <span class="err">:</span> <span class="s2">"</span><span class="err">$</span><span class="s2">context.identity.user"</span><span class="p">,</span>
      <span class="s2">"requestTime"</span> <span class="err">:</span> <span class="s2">"</span><span class="err">$</span><span class="s2">context.requestTime"</span><span class="p">,</span>
      <span class="s2">"httpMethod"</span> <span class="err">:</span> <span class="s2">"</span><span class="err">$</span><span class="s2">context.httpMethod"</span><span class="p">,</span>
      <span class="s2">"resourcePath"</span> <span class="err">:</span> <span class="s2">"</span><span class="err">$</span><span class="s2">context.resourcePath"</span><span class="p">,</span>
      <span class="s2">"status"</span> <span class="err">:</span> <span class="s2">"</span><span class="err">$</span><span class="s2">context.status"</span><span class="p">,</span>
      <span class="s2">"protocol"</span> <span class="err">:</span> <span class="s2">"</span><span class="err">$</span><span class="s2">context.protocol"</span><span class="p">,</span>
      <span class="s2">"responseLength"</span> <span class="err">:</span> <span class="s2">"</span><span class="err">$</span><span class="s2">context.responseLength"</span><span class="p">,</span>
      <span class="s2">"integrationErrorMessage"</span> <span class="err">:</span> <span class="s2">"</span><span class="err">$</span><span class="s2">context.integrationErrorMessage"</span><span class="p">,</span>
      <span class="s2">"errorMessage"</span> <span class="err">:</span> <span class="s2">"</span><span class="err">$</span><span class="s2">context.error.message"</span><span class="p">,</span>
      <span class="s2">"errorResponseType"</span> <span class="err">:</span> <span class="s2">"</span><span class="err">$</span><span class="s2">context.error.responseType"</span>
    <span class="p">})</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">resource</span> <span class="s2">"aws_apigatewayv2_route"</span> <span class="s2">"lambda_get_route"</span> <span class="p">{</span>
  <span class="nx">api_id</span>    <span class="p">=</span> <span class="nx">aws_apigatewayv2_api</span><span class="p">.</span><span class="nx">lambdagateway</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">route_key</span> <span class="p">=</span> <span class="s2">"GET /urlinfo/1"</span>
  <span class="nx">target</span>    <span class="p">=</span> <span class="s2">"integrations/</span><span class="k">${</span><span class="nx">aws_apigatewayv2_integration</span><span class="p">.</span><span class="nx">lambda_get_integration</span><span class="p">.</span><span class="nx">id</span><span class="k">}</span><span class="s2">"</span>
<span class="p">}</span>

<span class="k">resource</span> <span class="s2">"aws_apigatewayv2_integration"</span> <span class="s2">"lambda_get_integration"</span> <span class="p">{</span>
  <span class="nx">description</span> <span class="p">=</span> <span class="s2">"HTTP Integration HTTP GET to Lambda"</span>  
  <span class="nx">api_id</span>               <span class="p">=</span> <span class="nx">aws_apigatewayv2_api</span><span class="p">.</span><span class="nx">lambdagateway</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">integration_type</span>     <span class="p">=</span> <span class="s2">"AWS_PROXY"</span>
  <span class="nx">integration_method</span>   <span class="p">=</span> <span class="s2">"POST"</span>
  <span class="nx">integration_uri</span>      <span class="p">=</span> <span class="nx">aws_lambda_function</span><span class="p">.</span><span class="nx">malware_get_function</span><span class="p">.</span><span class="nx">invoke_arn</span>
  <span class="nx">passthrough_behavior</span> <span class="p">=</span> <span class="s2">"WHEN_NO_MATCH"</span>
<span class="p">}</span>

<span class="k">resource</span> <span class="s2">"aws_apigatewayv2_route"</span> <span class="s2">"lambda_post_route"</span> <span class="p">{</span>
  <span class="nx">api_id</span>    <span class="p">=</span> <span class="nx">aws_apigatewayv2_api</span><span class="p">.</span><span class="nx">lambdagateway</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">route_key</span> <span class="p">=</span> <span class="s2">"POST /addurl"</span>
  <span class="nx">target</span>    <span class="p">=</span> <span class="s2">"integrations/</span><span class="k">${</span><span class="nx">aws_apigatewayv2_integration</span><span class="p">.</span><span class="nx">lambda_post_integration</span><span class="p">.</span><span class="nx">id</span><span class="k">}</span><span class="s2">"</span>
<span class="p">}</span>

<span class="k">resource</span> <span class="s2">"aws_apigatewayv2_integration"</span> <span class="s2">"lambda_post_integration"</span> <span class="p">{</span>
  <span class="nx">description</span> <span class="p">=</span> <span class="s2">"HTTP Integration HTTP POST to Lambda"</span>  
  <span class="nx">api_id</span>               <span class="p">=</span> <span class="nx">aws_apigatewayv2_api</span><span class="p">.</span><span class="nx">lambdagateway</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">integration_type</span>     <span class="p">=</span> <span class="s2">"AWS_PROXY"</span>
  <span class="nx">integration_method</span>   <span class="p">=</span> <span class="s2">"POST"</span>
  <span class="nx">integration_uri</span>      <span class="p">=</span> <span class="nx">aws_lambda_function</span><span class="p">.</span><span class="nx">malware_post_function</span><span class="p">.</span><span class="nx">invoke_arn</span>
  <span class="nx">passthrough_behavior</span> <span class="p">=</span> <span class="s2">"WHEN_NO_MATCH"</span>
<span class="p">}</span>

<span class="k">resource</span> <span class="s2">"aws_lambda_permission"</span> <span class="s2">"api_gw_get"</span> <span class="p">{</span>  
  <span class="nx">action</span>        <span class="p">=</span> <span class="s2">"lambda:InvokeFunction"</span>
  <span class="nx">function_name</span> <span class="p">=</span> <span class="nx">aws_lambda_function</span><span class="p">.</span><span class="nx">malware_get_function</span><span class="p">.</span><span class="nx">function_name</span>
  <span class="nx">principal</span>     <span class="p">=</span> <span class="s2">"apigateway.amazonaws.com"</span>
  <span class="nx">source_arn</span>    <span class="p">=</span> <span class="s2">"</span><span class="k">${</span><span class="nx">aws_apigatewayv2_api</span><span class="p">.</span><span class="nx">lambdagateway</span><span class="p">.</span><span class="nx">execution_arn</span><span class="k">}</span><span class="s2">/*/*/*"</span>
<span class="p">}</span>

<span class="k">resource</span> <span class="s2">"aws_lambda_permission"</span> <span class="s2">"api_gw_post"</span> <span class="p">{</span>  
  <span class="nx">action</span>        <span class="p">=</span> <span class="s2">"lambda:InvokeFunction"</span>
  <span class="nx">function_name</span> <span class="p">=</span> <span class="nx">aws_lambda_function</span><span class="p">.</span><span class="nx">malware_post_function</span><span class="p">.</span><span class="nx">function_name</span>
  <span class="nx">principal</span>     <span class="p">=</span> <span class="s2">"apigateway.amazonaws.com"</span>
  <span class="nx">source_arn</span>    <span class="p">=</span> <span class="s2">"</span><span class="k">${</span><span class="nx">aws_apigatewayv2_api</span><span class="p">.</span><span class="nx">lambdagateway</span><span class="p">.</span><span class="nx">execution_arn</span><span class="k">}</span><span class="s2">/*/*/*"</span>
<span class="p">}</span>
</pre></table></code></div></div><h1 id="cloudwatch">CloudWatch</h1><p>Although CloudWatch was not part of the original architecture, it was extremely valuable when troubleshooting and debugging. CloudWatch allows you to publish log groups from the various components to one place, making it easier to diagnose failures.</p><p>The first thing was to create the log groups for each component. I was mainly concerned with getting some data on what was coming in to the HTTP API Gateway, and what was coming in to the Lambda functions. I set up log groups for each of these, and a policy to allow give permissions for logging to CloudWatch.</p><div class="language-terraform highlighter-rouge"><div class="code-header"> <span data-label-text="Terraform"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre><td class="rouge-code"><pre><span class="c1"># --- cloudwatch.tf ---</span>

<span class="k">resource</span> <span class="s2">"aws_cloudwatch_log_group"</span> <span class="s2">"api_gw"</span> <span class="p">{</span>
  <span class="nx">name</span>              <span class="p">=</span> <span class="s2">"/aws/api_gw/</span><span class="k">${</span><span class="nx">aws_apigatewayv2_api</span><span class="p">.</span><span class="nx">lambdagateway</span><span class="p">.</span><span class="nx">name</span><span class="k">}</span><span class="s2">"</span>
  <span class="nx">retention_in_days</span> <span class="p">=</span> <span class="mi">14</span>
<span class="p">}</span>

<span class="k">resource</span> <span class="s2">"aws_cloudwatch_log_group"</span> <span class="s2">"lambda_get"</span> <span class="p">{</span>
  <span class="nx">name</span>              <span class="p">=</span> <span class="s2">"/aws/lambda/</span><span class="k">${</span><span class="nx">aws_lambda_function</span><span class="p">.</span><span class="nx">malware_get_function</span><span class="p">.</span><span class="nx">function_name</span><span class="k">}</span><span class="s2">"</span>
  <span class="nx">retention_in_days</span> <span class="p">=</span> <span class="mi">14</span>
<span class="p">}</span>

<span class="k">resource</span> <span class="s2">"aws_cloudwatch_log_group"</span> <span class="s2">"lambda_post"</span> <span class="p">{</span>
  <span class="nx">name</span>              <span class="p">=</span> <span class="s2">"/aws/lambda/</span><span class="k">${</span><span class="nx">aws_lambda_function</span><span class="p">.</span><span class="nx">malware_post_function</span><span class="p">.</span><span class="nx">function_name</span><span class="k">}</span><span class="s2">"</span>
  <span class="nx">retention_in_days</span> <span class="p">=</span> <span class="mi">14</span>
<span class="p">}</span>

<span class="k">resource</span> <span class="s2">"aws_iam_policy"</span> <span class="s2">"lambda_logging"</span> <span class="p">{</span>
  <span class="nx">name</span>        <span class="p">=</span> <span class="s2">"lambda_logging"</span>
  <span class="nx">path</span>        <span class="p">=</span> <span class="s2">"/"</span>
  <span class="nx">description</span> <span class="p">=</span> <span class="s2">"IAM policy for logging from a Lambda"</span>

  <span class="nx">policy</span> <span class="p">=</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Action": [
        "logs:CreateLogGroup",
        "logs:CreateLogStream",
        "logs:PutLogEvents"
      ],
      "Resource": "arn:aws:logs:*:*:*",
      "Effect": "Allow"
    }
  ]
}
</span><span class="no">EOF
</span><span class="p">}</span>

<span class="k">resource</span> <span class="s2">"aws_iam_role_policy_attachment"</span> <span class="s2">"lambda_logs"</span> <span class="p">{</span>
  <span class="nx">role</span>       <span class="p">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">lambda_role</span><span class="p">.</span><span class="nx">name</span>
  <span class="nx">policy_arn</span> <span class="p">=</span> <span class="nx">aws_iam_policy</span><span class="p">.</span><span class="nx">lambda_logging</span><span class="p">.</span><span class="nx">arn</span>
<span class="p">}</span>
</pre></table></code></div></div><h1 id="test">Test</h1><p>To test the entire setup, I mainly used Postman to craft HTTP GET and POST messages.</p><p>When testing with Postman, I could add the HTTP API Gateway Invoke URL, select the type of HTTP request, and add the MalwareURL as a parameter:</p><p><img data-src="/project-assets/UsingAWSLambdaWithAPIGateway/GetTest.png" alt="Get Test" data-proofer-ignore></p><p><img data-src="/project-assets/UsingAWSLambdaWithAPIGateway/PostTest.png" alt="Post Test" data-proofer-ignore></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/programming/'>Programming</a>, <a href='/categories/python/'>Python</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/terraform/" class="post-tag no-text-decoration" >terraform</a> <a href="/tags/python/" class="post-tag no-text-decoration" >python</a> <a href="/tags/aws/" class="post-tag no-text-decoration" >aws</a> <a href="/tags/automation/" class="post-tag no-text-decoration" >automation</a> <a href="/tags/api-gateway/" class="post-tag no-text-decoration" >api gateway</a> <a href="/tags/lambda/" class="post-tag no-text-decoration" >lambda</a> <a href="/tags/cloudwatch/" class="post-tag no-text-decoration" >cloudwatch</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Using+AWS+Lambda+and+API+Gateway+to+Check+https%3A%2F%2Fochoaprojects.github.io%2Fposts%2FUsingAWSLambdaWithAPIGateway%2Fs+-+OchoaProjects&url=https%3A%2F%2Fochoaprojects.github.io%2Fposts%2FUsingAWSLambdaWithAPIGateway%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Using+AWS+Lambda+and+API+Gateway+to+Check+https%3A%2F%2Fochoaprojects.github.io%2Fposts%2FUsingAWSLambdaWithAPIGateway%2Fs+-+OchoaProjects&u=https%3A%2F%2Fochoaprojects.github.io%2Fposts%2FUsingAWSLambdaWithAPIGateway%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fochoaprojects.github.io%2Fposts%2FUsingAWSLambdaWithAPIGateway%2F&text=Using+AWS+Lambda+and+API+Gateway+to+Check+https%3A%2F%2Fochoaprojects.github.io%2Fposts%2FUsingAWSLambdaWithAPIGateway%2Fs+-+OchoaProjects" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/ProxMoxSetupInstall/">ProxMox Setup and Installation</a><li><a href="/posts/AboutMeAndTopology/">About Me and Homelab Topology</a><li><a href="/posts/PlexAutomation/">Plex Automation</a><li><a href="/posts/ProxMoxCloudInitImage/">Create a Debian Cloud-Init Template on Proxmox</a><li><a href="/posts/ProvisionDockerWithAnsible/">Provision a Linux Server With Docker Using Ansible</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/automation/">automation</a> <a class="post-tag" href="/tags/aws/">aws</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/proxmox/">proxmox</a> <a class="post-tag" href="/tags/terraform/">terraform</a> <a class="post-tag" href="/tags/cloudinit/">cloudinit</a> <a class="post-tag" href="/tags/containers/">containers</a> <a class="post-tag" href="/tags/ec2/">ec2</a> <a class="post-tag" href="/tags/kubernetes/">kubernetes</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/CheckS3BucketsWithLambdaFunction/"><div class="card-body"> <em class="small" data-ts="1656349200" data-df="ll" > Jun 27, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Checking AWS S3 Buckets With Python Lambda Function</h3><div class="text-muted small"><p> This will be a basic example on using a python Lambda function to check S3 Buckets. Table of Contents Create a Lambda Function in AWS Python Code Source for Function Explaining the...</p></div></div></a></div><div class="card"> <a href="/posts/TerraformWithAWS/"><div class="card-body"> <em class="small" data-ts="1656435600" data-df="ll" > Jun 28, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Automating AWS VPC and EC2 Instances using Terraform</h3><div class="text-muted small"><p> Terraform is a powerful tool that allows us to automate infrastructure in our cloud providers and much more. Using terraform to automate the building and configuration of our AWS enviornment to be ...</p></div></div></a></div><div class="card"> <a href="/posts/DeployingVMsWithTerraformInProxMox/"><div class="card-body"> <em class="small" data-ts="1654448400" data-df="ll" > Jun 5, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Deploying VMs With Terraform In ProxMox</h3><div class="text-muted small"><p> Leveraging our ProxMox cloud-init templates to deploy VMs entirely through Terraform quickly and easily. Table of Contents Prep a cloud-init template to use with Terraform Install qe...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/PlexAutomation/" class="btn btn-outline-primary" prompt="Older"><p>Plex Automation</p></a> <a href="/posts/SessionManagerAWS/" class="btn btn-outline-primary" prompt="Newer"><p>Session Manager for AWS</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://github.com/ochoaprojects">Brandon Ochoa</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> hosted on Github</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/automation/">automation</a> <a class="post-tag" href="/tags/aws/">aws</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/proxmox/">proxmox</a> <a class="post-tag" href="/tags/terraform/">terraform</a> <a class="post-tag" href="/tags/cloudinit/">cloudinit</a> <a class="post-tag" href="/tags/containers/">containers</a> <a class="post-tag" href="/tags/ec2/">ec2</a> <a class="post-tag" href="/tags/kubernetes/">kubernetes</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
